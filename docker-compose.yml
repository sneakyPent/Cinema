version: "3.8"



services:
    db:
        image: rwgrim/docker-noop
        depends_on:
            - keyrock_db
            - mongo-orion
            - mongo-data

    db-gui:
        image: rwgrim/docker-noop
        depends_on:
            - phpmyadmin
            - mongo-express-data
            - mongo-express-orion


#    fiware_services:
#        image: rwgrim/docker-noop
#        depends_on:
#            - keyrockIDM
#            - orion_CB
#                - pep-proxy-wilma

    myApp:
        image: rwgrim/docker-noop
        depends_on:
            - application
            - vue
            - mongo-express


    # --------------------------------------- DATABASES ---------------------------------------
    mongo-orion:
        container_name: DB-ORION
        image: mongo:3.6
        restart: always
        ports:
            - "27017:27017"
        command: mongod --nojournal --port 27017 --smallfiles --oplogSize 128
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: mongoadmin
            MONGO_INITDB_DATABASE: orion_DB
            MONGODB_USER: orion
            MONGODB_DATABASE: orion_DB
            MONGODB_PASS: orion
        volumes:
            - ./dbDatas/mongo-orion-dt:/data/db

    mongo-data:
        container_name: DB-DATA
        image: mongo:3.6
        restart: always
        ports:
            - "27018:27017"
        command: mongod --nojournal --port 27018 --smallfiles --oplogSize 128
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: mongoadmin
            MONGO_INITDB_DATABASE: myCinema_DB
            MONGODB_USER: cinema
            MONGODB_DATABASE: myCinema_DB
            MONGODB_PASS: cinema
        volumes: 
            - ./dbDatas/mongo-data:/data/db

    keyrock_db:
        container_name: DB-KEYROCK
        image: mysql/mysql-server:5.7.21
        expose:
            - 3306
        ports:
            - '3306:3306'
        environment:
            - MYSQL_ROOT_PASSWORD=idm
            - MYSQL_ROOT_HOST=%
        volumes:
            - ./dbDatas/keyrock_db:/var/lib/mysql

    # ------------------------------------ DATABASES UIs --------------------------------

    phpmyadmin:
        image: phpmyadmin/phpmyadmin:4.8
        container_name: PHPMYADMIN
        ports:
            - "8083:80"
        environment:
            - PMA_HOST=keyrock_db
        depends_on:
            - keyrock_db
        links:
            - keyrock_db:mysql
        restart: always

    mongo-express-data:
        image: mongo-express
        container_name: MN-DATA-EXPRESS
        restart: always
        ports:
            - 8081:8081
        environment:
            ME_CONFIG_MONGODB_ADMINUSERNAME: root
            ME_CONFIG_MONGODB_ADMINPASSWORD: mongoadmin
            ME_CONFIG_MONGODB_SERVER: mongo-data
            ME_CONFIG_MONGODB_PORT: 27018

    mongo-express-orion:
        image: mongo-express
        container_name: MN-ORION-EXPRESS
        restart: always
        ports:
            - 8082:8081
        environment:
            ME_CONFIG_MONGODB_ADMINUSERNAME: root
            ME_CONFIG_MONGODB_ADMINPASSWORD: mongoadmin
            ME_CONFIG_MONGODB_SERVER: mongo-orion
            ME_CONFIG_MONGODB_PORT: 27017


    keyrockIDM:
        container_name: FIWARE-KEYROCK
        image: fiware/idm
        expose:
            - 3005
        ports:
            - '3005:3005'
            - '3443:3443'
        environment:
            - IDM_DB_HOST=keyrock_db
            - IDM_PORT=3005
            - IDM_HOST=http://localhost:3005
        links:
            - keyrock_db
        volumes:
            - .:/fiware/keyrockIDM




    application:
        container_name: APPLICATION
        build:
            context: .
            dockerfile: DockerFiles/python/pythonDF
        command: sh scripts/django.sh
        volumes:
            - .:/web
        ports:
            - 8000:8000
        links:
            - mongo-data
        depends_on:
            - vue

    vue:
        restart: always
        container_name: VUE
        build:
            context: .
            dockerfile: DockerFiles/vue/vueDF
        command: sh scripts/frontend.sh
        ports:
            - 80:80
        volumes:
            - .:/frontend